<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Detalle de Pago</title>
    <style>
      body {
        font-family: 'Segoe UI', sans-serif;
        background: #dcdde1;
        margin: 0;
        padding: 32px;
      }

      .card {
        max-width: 820px;
        margin: 0 auto;
        background: #e3e4e6;
        border: 1px solid #404040;
        border-radius: 8px;
        padding: 22px;
      }

      .title {
        margin: 0 0 6px 0;
        text-align: center;
        font-size: 22px;
        font-weight: 700;
        color: #222;
      }

      .sub {
        margin: 0 0 14px 0;
        text-align: center;
        color: #444;
        font-size: 14px;
      }

      .check {
        width: 60px;
        height: 60px;
        background: #22c55e;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 34px;
        color: #fff;
        margin: 8px auto 10px auto;
      }

      .grid {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 10px 16px;
        align-items: center;
      }

      .label {
        color: #222;
        font-weight: 600;
      }

      .pill {
        background: #eef2f7;
        border-radius: 18px;
        padding: 8px 14px;
        display: inline-block;
        min-height: 20px;
        white-space: pre-line;
      }

      .badge-state {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 18px;
        color: #fff;
        font-weight: 700;
        font-size: 12px;
      }

      .st-completado { background: #22c55e; }
      .st-pendiente { background: #3f3d56; }
      .st-vencido { background: #9ca3af; }
      .st-sobrante { background: #f59e0b; }
      .st-faltante { background: #ef4444; }

      .actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 16px;
      }

      .btn {
        border: none;
        border-radius: 22px;
        padding: 10px 18px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn.secondary {
        background: #6b7280;
        color: #fff;
        text-decoration: none;
      }

      .btn.share {
        background: #10b981;
        color: #fff;
        display: flex;
        align-items: center;
        gap: 8px;
      }
    </style>
  </head>

  <body>
    <!-- üîπ Contenedor principal obligatorio -->
    <div class="card" id="card">
      <h2 class="title">Pago Confirmado</h2>
      <div class="sub" id="sub">ID Orden: ‚Äî</div>
      <div class="check">‚úì</div>

      <div class="grid">
        <div class="label">Estado de cobro</div>
        <div id="estado">
          <span class="badge-state st-pendiente">pendiente</span>
        </div>

        <div class="label">Monto</div>
        <div class="pill" id="monto">$‚Äî</div>

        <div class="label">Referencia</div>
        <div class="pill" id="desc">‚Äî</div>

        <div class="label">Cuenta Origen</div>
        <div class="pill" id="cuenta">‚Äî</div>

        <div class="label">Alias / CVU</div>
        <div class="pill" id="aliascvu">‚Äî</div>

        <div class="label">Fecha</div>
        <div class="pill" id="fecha">‚Äî</div>

        <div class="label">Hora</div>
        <div class="pill" id="hora">‚Äî</div>

        <div class="label">ID Coelsa</div>
        <div class="pill" id="coelsa">‚Äî</div>
      </div>

      <div class="actions">
        <button class="btn share" id="shareBtn">Compartir</button>
        <a class="btn secondary" href="/index.html">Volver</a>
      </div>
    </div>

    <!-- üî∏ Tu script corregido -->
    <script>
      window.addEventListener("load", () => {
        const card = document.getElementById("card");
        if (!card) {
          console.error("‚ùå No se encontr√≥ el elemento #card en el DOM");
          return;
        }

        const q = new URLSearchParams(location.search);
        const order = q.get("order");

        if (!order) {
          card.innerHTML = "<p>Falta el par√°metro <b>order</b></p>";
          return;
        }

        fetch(`/api/payments/${order}`)
          .then(r => r.json())
          .then(p => {
            if (!p || p.error) {
              card.innerHTML = "<p>Pago no encontrado</p>";
              return;
            }

            const estado = p.status || "pendiente";
            const estadoMap = {
              completado: "st-completado",
              pendiente: "st-pendiente",
              vencido: "st-vencido",
              sobrante: "st-sobrante",
              faltante: "st-faltante",
            };
            document.getElementById("estado").innerHTML =
              `<span class="badge-state ${estadoMap[estado] || "st-pendiente"}">${estado}</span>`;

            document.getElementById("sub").textContent = `ID Orden: ${p.orderId}`;
            document.getElementById("monto").textContent = `$${p.amount}`;
            document.getElementById("desc").textContent = p.description || "‚Äî";

            const cuentaEl = document.getElementById("cuenta");
            if (p.paymentInfo?.cuentaOrigen && p.status === "completado") {
              const o = p.paymentInfo.cuentaOrigen;
              const origenTxt = [o.titular, o.cvu, o.banco, o.cuit ? `CUIT ${o.cuit}` : ""]
                .filter(Boolean)
                .join("\n");
              cuentaEl.textContent = origenTxt;
            } else {
              const titular = p.paymentInfo?.titular || "Cuenta Comercio LinkPago";
              const cuit = p.paymentInfo?.cuit || "";
              const cvu = p.paymentInfo?.cvu || "";
              cuentaEl.textContent = [cvu, cuit ? `CUIT ${cuit}` : "", titular]
                .filter(Boolean)
                .join("\n");
            }

            const alias = p.paymentInfo?.alias || "";
            const cvu = p.paymentInfo?.cvu || "";
            document.getElementById("aliascvu").textContent = [alias, cvu]
              .filter(Boolean)
              .join(" ¬∑ ");

            const ts = p.updatedAt || p.createdAt || new Date().toISOString();
            const d = new Date(ts);
            document.getElementById("fecha").textContent = d.toLocaleDateString();
            document.getElementById("hora").textContent = d.toLocaleTimeString([], {
              hour: "2-digit",
              minute: "2-digit",
            });

            document.getElementById("coelsa").textContent = p.paymentInfo?.coelsaId || "‚Äî";

            const shareBtn = document.getElementById("shareBtn");
            if (shareBtn)
              shareBtn.onclick = () => {
                const msg = `Pago confirmado
                ID Orden: ${p.orderId}
                Monto: $${p.amount}
                Ref: ${p.description || "-"}
                Estado: ${estado}`;
                const wurl = `https://wa.me/?text=${encodeURIComponent(msg)}`;
                window.open(wurl, "_blank");
              };
          })
          .catch(err => {
            console.error("‚ùå Error cargando el pago:", err);
            card.innerHTML = "<p>Error cargando el pago</p>";
          });
      });
    </script>
  </body>
</html>
