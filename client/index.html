<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>Panel de Cobros</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="css/index.css">
</head>

<body>

  <header>
    <h1>Panel de Cobros</h1>
    <button id="create-link">+ Crear link de pago</button>
    <button id="config-btn">‚öôÔ∏è Configuraci√≥n</button>
  </header>

  <!-- PANEL CONFIGURACI√ìN -->
  <div id="config-panel" class="modal-overlay-config">
  <div class="modal-content-config">
    <h2>Configuraci√≥n del Comercio</h2>
    
    <div class="input-group">
      <label>API Key</label>
      <div class="password-wrapper">
        <input type="password" id="cfg-api" placeholder="X-Cucuru-Api-Key">
        <button type="button" id="toggle-password" class="eye-btn">üëÅÔ∏è</button>
      </div>
    </div>

    <div class="input-group">
      <label>Collector ID</label>
      <input id="cfg-collector" placeholder="ID del recaudador (ej: FacuTest)">
    </div>

    <div class="input-group">
      <label>Prefijo Alias</label>
      <input id="cfg-prefix" placeholder="Ej: Pepsi">
    </div>

    <div class="modal-actions-config">
      <button id="cfg-close" class="btn-sec-config">Cerrar</button>
      <button id="cfg-save" class="btn-pri-config">Guardar Configuraci√≥n</button>
    </div>
  </div>
</div>


  <main>

    <!-- FORMULARIO CREACI√ìN -->
    <div id="form">
      <input id="amount" placeholder="Monto">
      <input id="desc" placeholder="Descripci√≥n">
      <input id="email" placeholder="Email cliente (opcional)">
      <input id="hours" placeholder="Vence en (hs)">
      <button id="create">Confirmar</button>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
      <button class="side-btn">üîÑ<span>Actualizar</span></button>
      <button class="side-btn">‚òÅÔ∏è<span>Descargar</span></button>
      <button class="side-btn">üìä<span>Datos<br>Estad√≠sticos</span></button>
    </div>

    <!-- TABLA -->
    <table id="list">
      <tr>
        <th>Estado</th>
        <th>ID</th>
        <th>Monto</th>
        <th>Descripci√≥n</th>
        <th>Link</th>
        <th>Acciones</th>
      </tr>
    </table>

  </main>


  <!-- POPUP CANCELACI√ìN -->
  <div id="cancel-popup">
    <div style="
      background:white;
      padding:25px 30px;
      border-radius:10px;
      width:340px;
      text-align:center;
      box-shadow:0 6px 20px rgba(0,0,0,0.25);
      animation:scaleIn .25s ease;
    ">
      <h3 style="margin-bottom:10px;color:#333;">¬øCancelar link?</h3>
      <p style="color:#666;font-size:14px;">Esta acci√≥n bloquear√° el alias y el CVU asociados al pago.</p>

      <div style="margin-top:20px; display:flex;gap:12px; justify-content:center;">
        <button id="cancel-no" style="padding:8px 18px;border:none;background:#b2bec3;color:#2d3436;border-radius:6px;cursor:pointer;">
          Volver
        </button>

        <button id="cancel-yes" style="padding:8px 18px;border:none;background:#dc2626;color:white;border-radius:6px;cursor:pointer;">
          Cancelar
        </button>
      </div>
    </div>
  </div>

  

  <!-- =============================
       SCRIPT ORIGINAL - SIN CAMBIOS
       ============================= -->
  <script>
  const API = '/api/payments';
  const getMerchantId = () => localStorage.getItem('merchantId');

  document.getElementById('create-link').onclick = () => {
    const form = document.getElementById('form');
    form.style.display = form.style.display === 'block' ? 'none' : 'block';
  };

  document.getElementById('create').onclick = async () => {
    const btn = document.getElementById('create');
    btn.disabled = true;
    btn.textContent = 'Creando Link de pago...';

    const amount = parseFloat(document.getElementById('amount').value);
    const desc = document.getElementById('desc').value;
    const email = document.getElementById('email').value;
    const hours = parseFloat(document.getElementById('hours').value) || 1;

    if (!amount || !desc) {
      showAdvertencia(`‚ö†Ô∏è Complete el campo Monto y Descripci√≥n`);
      btn.disabled = false;
      btn.textContent = 'Confirmar';
      return;
    }

    const res = await fetch(API, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        amount,
        description: desc,
        customerEmail: email,
        expiresInHours: hours,
        merchantId: MERCHANT_ID
      })
    });

    const json = await res.json();

    if (json.orderId) {
      showNotice(`‚úÖ Link creado correctamente`);
      loadList();
      document.getElementById('form').style.display = 'none';
      document.getElementById('amount').value = '';
      document.getElementById('desc').value = '';
      document.getElementById('email').value = '';
      document.getElementById('hours').value = '';
    } else {
      showAdvertencia(`‚ùå Error creando link: ${json.error || 'Intente nuevamente'}`);
    }

    btn.disabled = false;
    btn.textContent = 'Confirmar';
  };

  function showAdvertencia(msg) {
    let advertencia = document.getElementById('advertencia');
    if (!advertencia) {
      advertencia = document.createElement('div');
      advertencia.id = 'advertencia';
      advertencia.style = `
        background: #fff3cd;
        border: 1px solid #ffeeba;
        padding: 10px 15px;
        border-radius: 6px;
        margin-top: 15px;
        color: #856404;
        font-weight: 500;
        animation: fadeIn 0.3s ease;
      `;
      document.querySelector('main').prepend(advertencia);
    }
    advertencia.innerHTML = msg;
    advertencia.style.display = 'block';
    setTimeout(() => advertencia.style.display = 'none', 4000);
  }

  function showNotice(msg) {
    let notice = document.getElementById('notice');
    if (!notice) {
      notice = document.createElement('div');
      notice.id = 'notice';
      notice.style = `
        background: #e6ffe6;
        border: 1px solid #00aa00;
        padding: 10px 15px;
        border-radius: 6px;
        margin-top: 15px;
        color: #008000;
        font-weight: 500;
        animation: fadeIn 0.3s ease;
      `;
      document.querySelector('main').prepend(notice);
    }
    notice.innerHTML = msg;
    notice.style.display = 'block';
    setTimeout(() => notice.style.display = 'none', 4000);
  }

  async function loadList() {
    const currentId = getMerchantId();
    if (!currentId) return;
    const res = await fetch(API + '/all?merchantId=' + MERCHANT_ID);
    const arr = await res.json();
    const table = document.getElementById('list');
    table.innerHTML = `
      <tr>
        <th>Estado</th>
        <th>ID</th>
        <th>Monto</th>
        <th>Descripci√≥n</th>
        <th>Link</th>
        <th>Acciones</th>
      </tr>`;

    arr.forEach(p => {
      const tr = document.createElement('tr');
      let estadoClass = p.status;

      const paymentUrl = `${window.location.origin}/payment.html?order=${p.orderId}`;
      tr.innerHTML = `
        <td><span class="estado ${estadoClass}">${p.status}</span></td>
        <td>${p.orderId}</td>
        <td>$${p.amount}</td>
        <td>${p.description || '-'}</td>
        <td class="link-cell">
          <span data-full="${paymentUrl}">${paymentUrl}</span>
          <button class="copy-btn" data-link="${paymentUrl}">üìã</button>
        </td>
        <td>
          ${p.status === 'pendiente' || p.status === 'rechazado'
            ? `<button class="cancel-btn" onclick="cancelarPago('${p.orderId}')">‚ùå Cancelar</button>`
            : '-'}
        </td>
      `;
      table.appendChild(tr);
    });

    document.querySelectorAll('.side-btn')[0].onclick = () =>
      loadList() & showNotice('üîÑ Lista actualizada');

    document.querySelectorAll('.copy-btn').forEach(btn => {
      btn.onclick = () => {
        navigator.clipboard.writeText(btn.dataset.link);
        btn.textContent = '‚úÖ';
        setTimeout(() => btn.textContent = 'üìã', 1600);
      };
    });
  }

  let cancelOrderId = null;

  function cancelarPago(orderId) {
    cancelOrderId = orderId;
    const popup = document.getElementById("cancel-popup");
    popup.style.display = "flex";

    document.getElementById("cancel-no").onclick = () => {
      popup.style.display = "none";
    };

    document.getElementById("cancel-yes").onclick = async () => {
      try {
        const res = await fetch(`/api/payments/${cancelOrderId}/cancel`, { method: "POST" });
        const data = await res.json();
        popup.style.display = "none";

        if (data.success) {
          showNotice("‚úÖ Link cerrado correctamente.");
          loadList();
        } else showAdvertencia(data.error || "No se pudo cancelar el link.");

      } catch (err) {
        popup.style.display = "none";
        showAdvertencia("‚ö†Ô∏è Error de conexi√≥n.");
      }
    };
  }

   // abrir panel
 document.getElementById("config-btn").onclick = () => {
  document.getElementById("config-panel").style.display = "flex";
};

document.getElementById("cfg-close").onclick = () => {
  document.getElementById("config-panel").style.display = "none";
};

// L√ìGICA DEL OJO (MOSTRAR/OCULTAR)
document.getElementById("toggle-password").onclick = function() {
  const apiInput = document.getElementById("cfg-api");
  if (apiInput.type === "password") {
    apiInput.type = "text";
    this.textContent = "üôà";
  } else {
    apiInput.type = "password";
    this.textContent = "üëÅÔ∏è";
  }
};

// Cargar datos guardados
function loadConfig() {
  document.getElementById("cfg-api").value =
    localStorage.getItem("cfg_apiKey") || "";

  document.getElementById("cfg-collector").value =
    localStorage.getItem("cfg_collectorId") || "";

  document.getElementById("cfg-prefix").value =
    localStorage.getItem("cfg_aliasPrefix") || "";
}

loadConfig();

document.getElementById("cfg-save").onclick = async () => {
  const cucuruApiKey = document.getElementById("cfg-api").value.trim();
  const cucuruCollectorId = document.getElementById("cfg-collector").value.trim();
  const aliasPrefix = document.getElementById("cfg-prefix").value.trim();

  if (!cucuruApiKey || !cucuruCollectorId || !aliasPrefix) {
    showAdvertencia("‚ö†Ô∏è Complet√° todos los campos");
    return;
  }

  // Crear comercio en backend
  const res = await fetch("/api/clients", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      name: cucuruCollectorId,
      cucuruApiKey,
      cucuruCollectorId,
      aliasPrefix
    })
  });

  const json = await res.json();

  if (json._id) {
    // Guardar merchantId real
    localStorage.setItem("merchantId", json._id);

    // Guardar lo que escribi√≥ el usuario
    localStorage.setItem("cfg_apiKey", cucuruApiKey);
    localStorage.setItem("cfg_collectorId", cucuruCollectorId);
    localStorage.setItem("cfg_aliasPrefix", aliasPrefix);
    

    document.getElementById("config-panel").style.display = "none";
    showNotice("‚úÖ Configuraci√≥n guardada");
  } else {
    showAdvertencia("‚ùå Error guardando configuraci√≥n");
  }
};
  
  loadList();
</script>



</body>

</html>
